rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    /**
     * Core Philosophy:
     * This ruleset implements a robust hotel management security model. It distinguishes between 
     * guest/client privacy and internal staff operations. Security is enforced through a combination 
     * of path-based ownership for private client data and role-based access for hotel staff.
     *
     * Data Structure:
     * - Client-specific data is nested under /users/{userId}/clients to enforce strict isolation.
     * - Operational data (Rooms, Reservations, Invoices) are top-level collections accessible by staff.
     * - Authorization for staff is determined by the presence of a document in the /staff or /roles_admin collections.
     *
     * Key Security Decisions:
     * - Admin privileges are verified by checking for the existence of a record in the /roles_admin collection.
     * - Staff access is verified by the existence of a record in the /staff collection, indexed by the user's UID.
     * - Reservations and Invoices are readable by the linked Client or any Staff member.
     * - Critical relational integrity is enforced by ensuring internal IDs match path parameters and preventing 
     *   the reassignment of owners/creators on update.
     *
     * Denormalization for Authorization:
     * - Reservations include a 'clientId' field to allow clients to view their own bookings without 
     *   expensive queries or complex joins.
     * - Staff roles are stored directly within the /staff and /roles_admin collections for efficient lookups.
     */

    // --- Helper Functions ---

    function isSignedIn() {
      return request.auth != null;
    }

    function isOwner(userId) {
      return isSignedIn() && request.auth.uid == userId;
    }

    // Helper for update/delete to ensure document exists and user owns it
    function isExistingOwner(userId) {
      return resource != null && isOwner(userId);
    }

    // Checks if the user is registered as a staff member
    function isStaff() {
      return isSignedIn() && exists(/databases/$(database)/documents/staff/$(request.auth.uid));
    }

    // Checks if the user has global admin privileges via the roles_admin collection
    function isAdmin() {
      return isSignedIn() && exists(/databases/$(database)/documents/roles_admin/$(request.auth.uid));
    }

    // --- Rules ---

    /**
     * @description Rules for private client profiles nested under a user path.
     * @path /users/{userId}/clients/{clientId}
     * @allow Authenticated user (userId) creating or reading their own client records.
     * @deny A user trying to access the /clients collection of a different userId.
     * @principle Path-based ownership and relational integrity.
     */
    match /users/{userId}/clients/{clientId} {
      allow get, list: if isOwner(userId);
      allow create: if isOwner(userId) && request.resource.data.id == clientId;
      allow update: if isExistingOwner(userId) && request.resource.data.id == resource.data.id;
      allow delete: if isExistingOwner(userId);
    }

    /**
     * @description Rules for room inventory.
     * @path /rooms/{roomId}
     * @allow Any signed-in user to view rooms; only staff or admins can modify room data.
     * @deny Unauthenticated read; non-staff modification.
     * @principle Public/Internal read with staff-only writes.
     */
    match /rooms/{roomId} {
      allow get, list: if isSignedIn();
      allow create, update, delete: if isStaff() || isAdmin();
    }

    /**
     * @description Rules for hotel reservations.
     * @path /reservations/{reservationId}
     * @allow Staff to manage all reservations; Clients to read and create their own reservations.
     * @deny Clients updating or deleting reservations once confirmed (unless staff).
     * @principle Shared access based on linked clientId and Staff roles.
     */
    match /reservations/{reservationId} {
      allow get, list: if isStaff() || (isSignedIn() && resource.data.clientId == request.auth.uid);
      allow create: if isStaff() || (isSignedIn() && request.resource.data.clientId == request.auth.uid);
      allow update: if isStaff() || (isExistingOwner(resource.data.clientId) && request.resource.data.clientId == resource.data.clientId);
      allow delete: if isStaff() || isAdmin();
    }

    /**
     * @description Rules for invoices linked to reservations.
     * @path /invoices/{invoiceId}
     * @allow Staff access for billing management; access for clients is handled via staff/admin proxy or specific query.
     * @deny General public access.
     * @principle Role-based access for financial records.
     */
    match /invoices/{invoiceId} {
      allow get, list: if isStaff() || isAdmin();
      allow create, update, delete: if isStaff() || isAdmin();
    }

    /**
     * @description Rules for staff member profiles.
     * @path /staff/{staffId}
     * @allow A staff member reading their own profile or an Admin managing staff.
     * @deny Non-staff users reading the staff directory.
     * @principle Self-access and Admin-only management.
     */
    match /staff/{staffId} {
      allow get: if isOwner(staffId) || isStaff();
      allow list: if isStaff();
      allow create: if isAdmin() || (isOwner(staffId) && request.resource.data.id == staffId);
      allow update: if isAdmin() || (isExistingOwner(staffId) && request.resource.data.id == resource.data.id);
      allow delete: if isAdmin();
    }

    /**
     * @description Administrative role assignments. Document existence here grants admin status.
     * @path /roles_admin/{staffId}
     * @allow Only existing Admins to manage other Admin assignments.
     * @deny Staff or standard users modifying admin roles.
     * @principle Restricted administrative bootstrapping.
     */
    match /roles_admin/{staffId} {
      allow get: if isSignedIn();
      allow list, create, update, delete: if isAdmin();
    }

    /**
     * @description Analytical occupancy forecasts.
     * @path /occupancyForecasts/{forecastId}
     * @allow Staff or Admins to view and generate forecasts for business planning.
     * @deny Clients or public users accessing internal business metrics.
     * @principle Role-based restriction for internal analytics.
     */
    match /occupancyForecasts/{forecastId} {
      allow get, list: if isStaff() || isAdmin();
      allow create, update, delete: if isStaff() || isAdmin();
    }
  }
}

/**
 * PROTOTYPING MODE NOTICE:
 * These rules prioritize authorization and path-based security. 
 * Data schema validation (types, required fields) is intentionally omitted to allow for 
 * rapid frontend iteration. Relational fields (ids, owner fields) are enforced for 
 * security integrity.
 */